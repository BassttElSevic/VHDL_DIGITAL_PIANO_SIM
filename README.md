# VHDL 数字电子琴模拟器

一个用 VHDL 编写的数字电子琴小程序，在 Quartus 平台上开发实现。这是一个完整的硬件设计项目，包含按键检测、音频信号生成、录音回放和 LCD 显示等功能。

## 📋 项目概述

本项目实现了一个功能完整的数字电子琴系统，包括：
- **7键电��琴**：支持 Do、Re、Mi、Fa、Sol、La、Ti 7个音符
- **实时音频生成**：通过方波信号生成各个音符的声音
- **录音和回放**：支持录制最多32个音符并回放
- **LCD显示**：实时显示当前操作信息和录制的音符

## 🏗️ 系统架构

项目采用模块化设计，由以下四个主要部分组成：

### 1. 优先编码器 (CODER)
- **功能**：将7个按键输入转换为3位二进制编码
- **输入**：K1-K7 七个按键信号（低电平有效）
- **输出**：
  - `CODER_OUTPUT`：3位二进制键码（000-110代表7个音符，111为无键按下）
  - `KEY_PRESSED`：按键按下标志位

### 2. 方波发生器 (PULSE_GENERATOR)
- **功能**：根据键码生成对应频率的方波信号
- **音符频率设定**：
  - Do (000): 262Hz → 计数值: 95556
  - Re (001): 294Hz → 计数值: 85131
  - Mi (010): 330Hz → 计数值:  75843
  - Fa (011): 349Hz → 计数值: 71586
  - Sol (100): 392Hz → 计数值:  63776
  - La (101): 440Hz → 计数值:  56818
  - Ti (110): 494Hz → 计数值: 50607
- **使能信号**：用于静音控制

### 3. 录音与回放模块 (RECORDER_PLAYER)
- **功能**：
  - 录制用户按键序列（最多32个音符）
  - 检测"Again"按键播放录制内容
  - 通过锁定计时器（100ms）防止按键抖动
  - 触发LCD写入请求
- **内部内存**：32个8位音符存储单元
- **状态机**：IDLE(空闲) → PLAYBACK(回放) → FINISH_CLEAR(清除)

### 4. LCD显示器驱动 (LCDDISPLAYER)
- **功能**：控制16x2字符LCD显示屏
- **特性**：
  - 支持初始化序列（Function Set、Display On、Clear、Entry Mode）
  - 事件驱动设计，响应写入和清屏请求
  - 自动处理LCD时序和E脉冲生成
  - 字符编码转换（将音符代码转为ASCII码）

### 5. 顶层实体 (FINAL)
- 集成所有子模块
- 管理系统信号流和接口

## 🔌 硬件接口

### 输入信号
| 信号 | 功能 | 说明 |
|------|------|------|
| K1-K7 | 琴键输入 | 低电平有效（7个音符） |
| Again | 回放按钮 | 触发录音回放 |
| CLK | 系统时钟 | 建议50MHz |

### 输出信号
| 信号 | 功能 | 说明 |
|------|------|------|
| WAVE_OUT | 音频输出 | 方波信号，连接扬声器 |
| CODE_OUT | 调试输出 | 当前按键编码（3位） |
| LCD_DB0-7 | LCD数据总线 | 8位数据总线 |
| LCD_RS | LCD寄存器选择 | 0=命令，1=数据 |
| LCD_E | LCD使能信号 | 锁存控制脉冲 |

## 🎯 工作流程

### 正常演奏模式
1. 用户按下琴键（K1-K7）
2. 编码器识别并输出对应的音符编码
3. 方波发生器生成该频率的声波信号
4. LCD显示当前演奏的音符
5. 同时自动记录该音符到内存中

### 回放模式
1. 用户按下"Again"按钮
2. 系统进入PLAYBACK状态
3. 按照录制顺序依次播放各个音符
4. 每个音符播放约500ms（基于25000000个时钟周期）
5. 回放完成后清屏并返回IDLE状态

## ⚙️ 技术亮点

1. **防抖设计**：采用100ms的锁定计时器，有效防止机械按键抖动
2. **边沿检测**：通过记录前一次状态，准确识别按键上升沿和下降沿
3. **内存优化**：使用32个音符的循环缓冲，充分利用FPGA资源
4. **LCD时序控制**：严格按照标准LCD时序生成命令和数据信号
5. **模块化设计**：各功能模块相互独立，易于维护和扩展

## 📁 项目文件

- `FINAL.vhd` - 主要源代码（包含所有模块的完整设计）
- `FINAL.qpf` - Quartus项目文件
- `FINAL.qsf` - Quartus设置文件
- `FINAL.qws` - Quartus工作区文件
- `FINAL_nativelink_simulation.rpt` - 仿真报告

## 🛠️ 开发环境

- **设计工具**：Altera Quartus II/Prime
- **硬件描述语言**：VHDL
- **目标硬件**：Altera FPGA（推荐DE系列开发板）
- **时钟频率**：50MHz

## 🔄 状态机设计

### RECORDER_PLAYER 状态转移

```
┌─────────────────────────────┐
│         IDLE                │ ◄─────────────────┐
├─────────────────────────────┤                   │
│ • 检测按键上升沿            │                   │
│ • 录制音符到内存            │                   │
│ • LCD显示当前音符           │                   │
│ • 检测Again按钮下降沿      │                   │
│ • 启动防抖计时器            │                   │
└──────────────┬──────────────┘                   │
               │                                   │
         Again被按下                              │
               │                                   │
               ▼                                   │
┌─────────────────────────────┐                   │
│       PLAYBACK              │                   │
├─────────────────────────────┤                   │
│ • 按顺序播放录制的音符      │                   │
│ • 每个音符持续500ms         │                   │
└──────────────┬──────────────┘                   │
               │                                   │
         播放完成                                  │
               │                                   │
               ▼                                   │
┌─────────────────────────────┐                   │
│      FINISH_CLEAR           │                   │
├─────────────────────────────┤                   │
│ • 停止发音                  │                   │
│ • 清屏                      │                   │
│ • 复位计数器                │                   │
└──────────────┬──────────────┘                   │
               │                                   │
               └───────────────────────────────────┘
```

### LCDDISPLAYER 初始化序列

```
POWER_ON (15ms延迟)
   ↓
INIT_FUNC (Function Set:  8-bit, 2-line)
   ↓
INIT_DISPLAY (Display On, No Cursor)
   ↓
INIT_CLEAR (Clear Screen - 2ms等待)
   ↓
INIT_ENTRY (Entry Mode:  Auto Increment)
   ↓
IDLE (等待写入或清屏请求)
```

## 💡 使用建议

1. **扩展音符范围**：可增加更多琴键和频率设定，扩展CODER和相关数组大小
2. **增加录制容量**：修改`MEMORY_ARRAY`的大小（当前32个音符）
3. **音符长度控制**：调整PLAYBACK状态中的timer常数以改变音符长度
4. **LCD显示内容**：在CODE_TO_ASCII函数中自定义不同的显示符号

## 🐛 已知限制

- 单键发音，不支持同时按多个键
- 录制容量为32个音符
- 不支持音符长度的动态控制
- LCD显示宽度受16×2字符限制

## 📝 示例使用流程

1. 连接硬件（按键、扬声器、LCD屏幕）
2. 编译并烧写到FPGA
3. 按下K1-K7开始演奏，每个按键对应一个音符
4. LCD屏幕显示当前演奏的音符编号
5. 按下Again按钮回放之���的录制
6. 回放完成后自动清屏，可重新开始

## 📞 项目信息

- **作者**：BassttElSevic
- **仓库地址**：https://github.com/BassttElSevic/VHDL_DIGITAL_PIANO_SIM
- **项目语言**：100% VHDL

---

**欢迎改进和扩展本项目！** 💻🎹
